import callWithRetry from "../callWithRetry.js";
import postMessage from "../postMessage.js";
import sleep from "../sleep.js";
import dayjs from "dayjs";
import { isInTheAllowedTime } from "../isInTheAllowedTime.js";
// å¼•å…¥mongodbModels
import {
    meetLiyuuModel,
    dailyOperationsModel,
    imagesModel,
} from "../databaseModels.js";
import { getFileInfo } from "../getFileInfo.js";

// è·å–å…è®¸çœ‹é²¤çš„å­é¢‘é“
import { getAllowedChannelId } from "../allowChannels/publicApi.js";

/**
 * è·å–å›¾ç‰‡
 * @param {string=} group_id ç¾¤èŠidï¼Œä¸å¡«è¿”å›åŸå§‹urlï¼Œå¡«å†™åè¿”å›file_info
 * @param {string=} specifyUrl urlï¼Œä¸å¡«éšæœºé²¤é±¼å›¾ç‰‡
 * @returns {string} file_infoæˆ–url
 */
const getPicture = async (group_id, specifyUrl) => {
    let url;
    if (specifyUrl) {
        url = specifyUrl;
    } else {
        url = await imagesModel
            .countDocuments()
            .then((count) => {
                const randomIndex = Math.floor(Math.random() * count);
                return imagesModel.findOne().skip(randomIndex).exec();
            })
            .then((res) => res.url)
            .catch((err) => {
                console.log(err);
            });
    }
    if (group_id) {
        const file_info = await getFileInfo(group_id, url);
        if (file_info == "") {
            return await getPicture(group_id);
        }
        return file_info;
    }
    return url;
};

// çœ‹é²¤
async function meetLiyuu(
    msg_id,
    destinationId,
    author,
    timestamp,
    guild_id,
    type = "guild"
) {
    if (type == "guild") {
        // è·å–å…è®¸çœ‹é²¤çš„å­é¢‘é“
        const meetLiyuuChannelId = await getAllowedChannelId(
            guild_id,
            "meetLiyuu"
        );
        // å¦‚æœå½“å‰å­é¢‘é“ä¸å…è®¸çœ‹é²¤
        if (
            meetLiyuuChannelId.findIndex(
                (i) => i.channel_id == destinationId
            ) == -1
        ) {
            callWithRetry(postMessage, [
                destinationId,
                {
                    content: `<@!${author}> å®å­~ä¸èƒ½åœ¨<#${destinationId}>çœ‹é²¤å“¦~\nç°åœ¨${
                        meetLiyuuChannelId
                            .map((i) => `<#${i.channel_id}>`)
                            .join("") == ""
                            ? "æ²¡æœ‰å­é¢‘é“"
                            : "æœ‰" +
                              meetLiyuuChannelId
                                  .map((i) => `<#${i.channel_id}>`)
                                  .join("")
                    }å¯ä»¥çœ‹é²¤~${meetLiyuuChannelId
                        .map((i) => `<#${i.channel_id}>`)
                        .join("") == ""?'\n\nå¦‚æœä½ æ˜¯ç®¡ç†å‘˜çš„è¯ï¼Œè¯·ä½¿ç”¨â€œ/è®¾ç½®çœ‹é²¤å­é¢‘â€æŒ‡ä»¤è®¾ç½®ä¸€ä¸ªå­é¢‘é“ç”¨æ¥çœ‹é²¤å§ï½':''}`,
                    msg_id,
                    image: "https://cdn.liyuu.ceek.fun/images/dame.jpg", // æ‘‡æ‘‡æ‰‹æŒ‡å¤§å’©å“Ÿ
                },
                (res) => {
                    console.log(res.data);
                },
                type,
            ]);
            return;
        }
    }

    // æ—¶é—´é™åˆ¶
    if (
        !isInTheAllowedTime(destinationId) &&
        type == "group"
    ) {
        callWithRetry(postMessage, [
            destinationId,
            {
                content: `\nå½“å‰ä¸åœ¨å¯ç”¨çœ‹é²¤æ—¶é—´\nè¯·åœ¨åŒ—äº¬æ—¶é—´ 00:00ï½09:00ã€17:00ï½18:00 æ¥çœ‹é²¤å“¦ï½${
                    destinationId == "DA863706233CF44DCB4B8EE105101591"
                        ? `\né¢‘é“çœ‹é²¤æ— é™åˆ¶ï¼Œå¸¸å›é¢‘é“çœ‹çœ‹~ï¼ˆå­é¢‘é“ ğŸ¤– | æ¯æ—¥æ‰“å¡ çœ‹é²¤ï¼‰`
                        : ""
                }`,
                msg_id,
                msg_type: 0,
            },
            (res) => {
                console.log(res.data);
            },
            type,
        ]);
        return;
    }

    // è·å–çœ‹é²¤æ‰€éœ€æ—¶é—´
    const meetLiyuuTimeout = 5;

    // è·å–çœ‹é²¤æ¬¡æ•°é™åˆ¶
    const limit = 5;

    // è·å–çœ‹é²¤ä»»åŠ¡
    const meetLiyuuDbData = await meetLiyuuModel
        .find({
            id: author,
            guild_id: type == "guild" ? guild_id : null,
            group_id: type == "group" ? destinationId : null,
        })
        .then((res) => {
            return res;
        });
    // ç›®å‰æœ‰çœ‹é²¤è®°å½•
    if (meetLiyuuDbData.length > 0) {
        // çœ‹é²¤å‰©ä½™æ‰€éœ€æ—¶é—´
        const leftTime = dayjs(meetLiyuuDbData[0].time)
            .add(meetLiyuuTimeout, "minute")
            .diff(dayjs(), "second");
        // è¿˜æœªå®Œæˆè§‚çœ‹
        if (leftTime > 0) {
            callWithRetry(postMessage, [
                destinationId,
                {
                    content:
                        (type == "guild" ? `<@!${author}> ` : "") +
                        `ä½ å·²ç»åœ¨çœ‹é²¤äº†ï¼Œè¯·ç­‰å¾…æœ¬è½®çœ‹é²¤ç»“æŸåå†ç»§ç»­å¼€å§‹å“¦ã€‚\né¢„è®¡è¿˜éœ€è¦è§‚çœ‹${parseInt(
                            leftTime / 60
                        )}åˆ†${
                            leftTime % 60
                        }ç§’ï¼Œçœ‹é²¤ç»“æŸåè¯·å‘é€â€œ/ç»“æŸçœ‹é²¤â€é¢†å–ç§¯åˆ†å“¦~`,
                    msg_id,
                    msg_type: 7,
                    image:
                        type == "guild"
                            ? "https://cdn.liyuu.ceek.fun/images/wenhao.jpg"
                            : undefined, //ï¼Ÿ
                    media:
                        type == "group"
                            ? await getPicture(
                                  destinationId,
                                  "https://cdn.liyuu.ceek.fun/images/wenhao.jpg"
                              )
                            : undefined,
                },
                (res) => {
                    console.log(res.data);
                },
                type,
            ]);
            return;
        }
        callWithRetry(postMessage, [
            destinationId,
            {
                content:
                    (type == "guild" ? `<@!${author}> ` : "") +
                    `ä¸Šä¸€è½®çš„çœ‹é²¤ç§¯åˆ†è¿˜æœªé¢†å–å“¦ï¼Œè¯·å…ˆå‘é€â€œ/ç»“æŸçœ‹é²¤â€é¢†å–å§~`,
                msg_id,
                msg_type: 7,
                image:
                    type == "guild"
                        ? "https://cdn.liyuu.ceek.fun/images/zhiren.jpg"
                        : undefined, //æŒ‡äºº
                media:
                    type == "group"
                        ? await getPicture(
                              destinationId,
                              "https://cdn.liyuu.ceek.fun/images/zhiren.jpg"
                          )
                        : undefined,
            },
            (res) => {
                console.log(res.data);
            },
            type,
        ]);
        return;
    }
    // è·å–æ­¤å‰çœ‹é²¤è®°å½•æ•°é‡
    const count = await dailyOperationsModel.countDocuments({
        id: author,
        type: "meetLiyuu",
        date: { $gte: new Date().setHours(0, 0, 0, 0) },
        guild_id: type == "guild" ? guild_id : null,
        group_id: type == "group" ? destinationId : null,
    });

    // è·å–æ–‡æ¡ˆ
    const getContent = (count, limit) => {
        // å¦‚æœåŠ ä¸Šè¿™æ¬¡çœ‹é²¤å·²ç»è¾¾åˆ°ä¸Šé™
        if (count == limit - 1) {
            return `${meetLiyuuTimeout}åˆ†é’Ÿåè®°å¾—å‘é€â€œ/ç»“æŸçœ‹é²¤â€\nä»Šæ—¥å·²çœ‹æ»¡${limit}æ¬¡é²¤ï¼Œ${
                type == "guild"
                    ? "æ¥ä¸‹æ¥çš„çœ‹é²¤éƒ½ä¸ä¼šåŠ ç§¯åˆ†å“¦ï½"
                    : "è¯·æ˜å¤©å†æ¥å§ï½"
            }`;
            // å¦‚æœå·²ç»è¶…è¿‡ä¸Šé™
        } else if (count >= limit) {
            return `æœ¬æ¬¡çœ‹é²¤å°†ä¸ä¼šå¢åŠ ç§¯åˆ†å“¦~`;
            // è¿˜æœ‰è‡³å°‘ä¸€æ¬¡çš„çœ‹é²¤æœºä¼š
        } else {
            return `${meetLiyuuTimeout}åˆ†é’Ÿåè®°å¾—å‘é€â€œ/ç»“æŸçœ‹é²¤â€\nä»Šå¤©è¿˜æœ‰${
                limit - (count + 1)
            }æ¬¡çœ‹é²¤æœºä¼š`;
        }
    };

    // ç¾¤èŠæ‹¦æˆª
    if (count >= limit && type == "group") {
        callWithRetry(postMessage, [
            destinationId,
            {
                content: `\nä»Šå¤©å·²ç»çœ‹æ»¡${limit}æ¬¡é²¤äº†ï¼Œè¯·æ˜å¤©å†æ¥å“¦ï½${
                    destinationId == "DA863706233CF44DCB4B8EE105101591"
                        ? `\né¢‘é“çœ‹é²¤æ— ä¸Šé™ï¼Œå¸¸å›é¢‘é“çœ‹çœ‹~ï¼ˆå­é¢‘é“ ğŸ¤– | æ¯æ—¥æ‰“å¡ çœ‹é²¤ï¼‰`
                        : ""
                }`,
                msg_id,
                msg_type: 7,
                media: await getPicture(
                    destinationId,
                    "https://i0.hdslb.com/bfs/new_dyn/d9334afd367cf2c2b03b80f49485621b35611279.jpg@150w_150h.jpg"
                ),
            },
            (res) => {
                console.log(res.data);
            },
            type,
        ]);
        return;
    }

    async function meetLiyuuWithRetry(
        destinationId,
        content,
        msg_id,
        thenFunc,
        retries = 0,
        errors = []
    ) {
        const retryTime = 5;
        try {
            const media = await getPicture(
                type == "group" ? destinationId : null
            );
            // å°è¯•å‘é€æ¶ˆæ¯å¹¶è·å–å‘é€ç»“æœ
            const result = await postMessage(
                destinationId,
                {
                    content,
                    msg_id,
                    image: type == "guild" ? media : undefined,
                    media: type == "group" ? media : undefined,
                    msg_type: 7,
                },
                thenFunc,
                type
            );
            return { result, errors };
        } catch (err) {
            // å¦‚æœå‡ºç°é”™è¯¯ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯å¹¶æ·»åŠ åˆ°é”™è¯¯æ•°ç»„ä¸­
            if (typeof err == "object") errors.push(JSON.stringify(err));
            else errors.push(String(err));

            // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
            if (retries < retryTime - 1) {
                // å¦‚æœéœ€è¦é‡è¯•ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åå†æ¬¡è°ƒç”¨å‡½æ•°
                await sleep(500);
                // æŠ›å‡ºé”™è¯¯
                console.log(JSON.stringify({ retries, errors }));
                return await meetLiyuuWithRetry(
                    destinationId,
                    content,
                    msg_id,
                    thenFunc,
                    ++retries,
                    errors
                );
            } else {
                // å¦‚æœä¸éœ€è¦é‡è¯•ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯å¹¶æŠ›å‡ºå¼‚å¸¸
                console.log(JSON.stringify({ errors }));
            }
        }
    }

    // å¦‚æœéœ€è¦å¼€å¯çœ‹é²¤ä»»åŠ¡
    if (count < limit) {
        await new meetLiyuuModel({
            id: author,
            time: timestamp,
            guild_id: type == "guild" ? guild_id : null,
            group_id: type == "group" ? destinationId : null,
        })
            .save()
            .then((dbRes) => {
                console.log("åˆ›å»ºçœ‹é²¤ä»»åŠ¡æˆåŠŸ", dbRes);
            })
            .catch((err) => {
                console.log("åˆ›å»ºçœ‹é²¤ä»»åŠ¡å¤±è´¥", err);
            });
        await new dailyOperationsModel({
            id: author,
            type: "meetLiyuu",
            guild_id: type == "guild" ? guild_id : null,
            group_id: type == "group" ? destinationId : null,
        })
            .save()
            .catch((err) => {
                console.log("è®°å½•çœ‹é²¤æ“ä½œå¤±è´¥", err);
            });
    }

    meetLiyuuWithRetry(
        destinationId,
        (type == "guild" ? `<@!${author}> ` : "") +
            `åˆæ¥çœ‹é²¤å•¦~\n${getContent(count, limit)}\nå¤šå¤šçœ‹é²¤ï¼Œé™¶å†¶æƒ…æ“ï¼`,
        msg_id
    );
}

export default meetLiyuu;
